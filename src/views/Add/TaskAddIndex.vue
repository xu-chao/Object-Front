<template>
  <div style="--van-nav-bar-icon-color:#F19290">
  <van-nav-bar
    title="Ê∑ªÂä†‰ªªÂä°"
    left-text=""
    left-arrow
    @click-left="onClickLeft"
  />
  </div>
  <div class="page-contain">
    <div class="content_addIndex">
      <van-swipe :autoplay="3000">
        <van-swipe-item v-for="image in images" :key="image">
          <img :src="image" class="image-slider_task" alt="ÂïÜÂìÅÂõæÁâá" />
        </van-swipe-item>
      </van-swipe>

      <van-loading vertical v-if="isLoading" class="loading-overlay">
        <template #icon>
          <van-icon name="star-o" size="30" />
        </template>
        Âä†ËΩΩ‰∏≠...
      </van-loading>

      <van-form class="form-container_task">
        <div>
          <meta
            name="viewport"
            content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0,user-scalable=no"
          />
          <!-- <van-field label="üîñÈÄâÊã©È¢ÑËÆæ" v-model="presetIndex" :options="presets" @change="onPresetChange($event)" /> -->
          <van-field
            v-model="presetIndex"
            is-link
            readonly
            label="üîñÈÄâÊã©È¢ÑËÆæ"
            placeholder="ÈÄâÊã©È¢ÑËÆæ"
            @click="showPicker = true"
          />
          <van-popup v-model:show="showPicker" round position="bottom ">
            <van-picker
              :columns="columns"
              @cancel="showPicker = false"
              @confirm="onConfirm"
              clearable
            />
          </van-popup>
          <van-field
            label="üìå‰ªªÂä°ÂêçÁß∞"
            v-model="title"
            placeholder="ËØ∑ËæìÂÖ•‰ªªÂä°ÂêçÁß∞"
            :autofocus="false"
            clearable
          />
          <van-field
            label="üìù‰ªªÂä°ËØ¶ÊÉÖ"
            v-model="desc"
            placeholder="ËØ∑ËæìÂÖ•‰ªªÂä°ËØ¶ÊÉÖ"
            type="textarea"
            rows="3"
            :autofocus="false"
            clearable
          />
          <!-- <van-field label="ü§ñ‰ªªÂä°ÂØπË±°" v-model="useName" placeholder="ËØ∑ËæìÂÖ•‰ªªÂä°ÂØπË±°" :autofocus="false" clearable/> -->
          <van-field
            v-model="useName"
            is-link
            readonly
            name="picker"
            label="ü§ñÂïÜÂìÅÂØπË±°"
            placeholder="ÁÇπÂáªÈÄâÊã©ÂïÜÂìÅÂØπË±°"
            @click="showPicker_1 = true"
            :rules="[{ required: true, message: 'ËØ∑ÈÄâÊã©ÂïÜÂìÅÂØπË±°' }]"
          />
          <van-popup v-model:show="showPicker_1" position="bottom">
            <van-picker
              :columns="userColumns"
              @confirm="onConfirm_1"
              @cancel="showPicker_1 = false"
            />
          </van-popup>
          <van-field
            label="üí∞ÁßØÂàÜ‰ª∑Ê†º"
            v-model="credit"
            placeholder="ËØ∑ËæìÂÖ•‰ªªÂä°ÁßØÂàÜ(Êï¥Êï∞)"
            :autofocus="false"
            clearable
          />
        </div>
      </van-form>

      <div class="footer_task">
        <van-button class="btn-reset" type="default" @click="resetItem"
          >ÈáçÁΩÆ</van-button
        >
        <van-button class="btn-save" color="#F19290" type="primary" @click="saveItem"
          >‰øùÂ≠ò</van-button
        >
      </div>
    </div>
    <van-dialog
      v-model:show="show"
      title="ü•∞ Ê∏©È¶®ÊèêÁ§∫"
      :message="message"
      :show-cancel-button="false"
    >
    </van-dialog>
    <van-dialog
      v-model:show="show_1"
      title="ü•∞ÊÅ≠Âñú"
      :message="message"
      width="70vw"
      height="30vw"
      :show-cancel-button="false"
      :show-confirm-button="false"
    >
    </van-dialog>
  </div>
</template>

<script>
import { ref, onMounted } from "vue"; // Ê∑ªÂä†‰∫Ü onUnmounted
import axios from "axios";
import png from "@/util/Mission.gif";
import { useRouter } from "vue-router";
import { Field, Form, Button, Swipe, SwipeItem } from "vant";
// Ëß£ÊûêJwt‰ª§Áâå
import jwtDecode from "jwt-decode";

export default {
  components: {
    VanField: Field,
    VanForm: Form,
    VanButton: Button,
    VanSwipe: Swipe,
    VanSwipeItem: SwipeItem,
  },

  setup() {
    const show = ref(false);
    const show_1 = ref(false);
    const message = ref("");
    const isLoading = ref(false);
    const onClickLeft = () => router.replace("/Task");
    const presetIndex = ref("Êó†È¢ÑËÆæ");
    const showPicker = ref(false);
    const title = ref("");
    const desc = ref("");
    const useName = ref("");
    const userColumns = ref([]);
    const showPicker_1 = ref(false);
    const credit = ref(0);

    const router = useRouter();
    const images = [png];
    onMounted(() => {
      fetchLoginToken();
      fetchUserData();
    });
    const token = localStorage.getItem("jwtToken"); // ‰ªélocalStorageËé∑ÂèñJWT‰ª§Áâå

    if (!token) {
      router.replace("/login");
    }
    const headers = {
      Authorization: `Bearer ${token}`,
    };
    let userId = "";
    const fetchLoginToken = () => {
      axios
        .post("/api/loginToken?token=" + token)
        .then((response) => {
          if (response.data.code == 0) {
            console.error(response.data.data);
            router.replace("/login");
            return;
          }
          const decodedToken = jwtDecode(token);
          // ‰ªéËß£Á†ÅÂêéÁöÑ‰ª§Áâå‰∏≠Ëé∑ÂèñÁâπÂÆöÁöÑÊï∞ÊçÆ
          userId = decodedToken.id; // ‰ªé‰ª§Áâå‰∏≠Ëé∑ÂèñÁî®Êà∑ID
          // Âú®ËøôÈáåÂ§ÑÁêÜÁôªÂΩï‰ª§ÁâåÊé•Âè£ÁöÑÂìçÂ∫î
          // Â¶ÇÊûúÈúÄË¶ÅÊâßË°å‰∏Ä‰∫õÁâπÂÆöÁöÑÊìç‰ΩúÔºåÂèØ‰ª•Âú®ËøôÈáåÊ∑ªÂä†‰ª£Á†Å
        })
        .catch((error) => {
          console.error("ËØ∑Ê±ÇloginTokenÊé•Âè£Â§±Ë¥•", error);
          router.replace("/login");
        });
    };
    const fetchUserData = async () => {
      try {
        const response = await axios.get("/api/user", {
          headers,
        }); // ÊõøÊç¢‰∏∫ÂÆûÈôÖÁöÑAPIÁ´ØÁÇπ
        const userData = response.data.data; // ÂÅáËÆæAPIËøîÂõû‰∏Ä‰∏™ÂåÖÂê´Áî®Êà∑Êï∞ÊçÆÁöÑÊï∞ÁªÑ
        // 2. Â∞ÜÁî®Êà∑Êï∞ÊçÆËΩ¨Êç¢‰∏∫ÈÄâÊã©Âô®ÁöÑÂàóÊ†ºÂºè
        userColumns.value = userData
          .filter((user) => user.nameId !== userId)
          .map((user) => ({
            text: user.name,
            value: user.nameId,
          }));
      } catch (error) {
        console.error("Ëé∑ÂèñÁî®Êà∑Êï∞ÊçÆÊó∂Âá∫Èîô", error);
      }
    };
    const onConfirm_1 = ({ selectedOptions }) => {
      useName.value = selectedOptions[0]?.text;
      showPicker_1.value = false;
    };
    const columns = [
      { text: "Êó†È¢ÑËÆæ", value: "0" },
      { text: "Êó©Áù°Êó©Ëµ∑", value: "1" },
      { text: "ÊâìÊâ´ÊàøÈó¥", value: "2" },
      { text: "ÂÅ•Â∫∑ËøêÂä®", value: "3" },
      { text: "‰∏äËØæ‰∏çËøüÂà∞", value: "4" },
      { text: "ÂÅö‰πñÂÆùÂÆù", value: "5" },
      { text: "‰π∞Â∞èÁ§ºÁâ©", value: "6" },
      { text: "Â•ΩÊÑüÂàÜ", value: "7" },
      { text: "Â∏ÆÊãø‰∏úË•ø", value: "8" },
      { text: "‰∏çÂñùÈ•ÆÊñô", value: "9" },
      { text: "ËÆ§ÁúüÁúãËØæ", value: "10" },
      { text: "ËÉåÂçïËØç", value: "11" },
      { text: "ÂêÉËî¨Ëèú", value: "12" },
      { text: "ÁôΩÂ§©‰∏çÁù°Ëßâ", value: "13" },
    ];

    const onConfirm = ({ selectedOptions }) => {
      showPicker.value = false;
      presetIndex.value = selectedOptions[0].text;
      onPresetChange(selectedOptions[0].text); // Ë∞ÉÁî® onPresetChange ÂáΩÊï∞ÔºåÊâãÂä®Ëß¶ÂèëÂÄºÂèòÂåñ
    };

    const onPresetChange = (value) => {
      // Ê†πÊçÆÈÄâÊã©ÁöÑÈ¢ÑËÆæÂÄºÊù•Ëá™Âä®Â°´ÂÖÖÂÖ∂‰ªñ‰ø°ÊÅØ
      if (value === "Êó©Áù°Êó©Ëµ∑") {
        title.value = value;
        desc.value = "ÁÜ¨Â§úÂØπË∫´‰ΩìÂæà‰∏çÂ•ΩÔºåËøòÊòØË¶ÅÊó©ÁÇπÁù°ËßâÁ¨¨‰∫åÂ§©ÊâçËÉΩÊúâÁ≤æÁ•ûÔºÅ";
      } else if (value === "ÊâìÊâ´ÊàøÈó¥") {
        title.value = value;
        desc.value = "Êúâ‰∏ÄÊÆµÊó∂Èó¥Ê≤°ÊúâÊâìÊâ´ÊàøÈó¥‰∫ÜÔºå‰∏ÄÂ±ã‰∏çÊâ´Ôºå‰Ωï‰ª•Êâ´Â§©‰∏ãÔºü";
      } else if (value === "ÂÅ•Â∫∑ËøêÂä®") {
        title.value = value;
        desc.value = "ÂÅö‰∏Ä‰∫õÂÅ•Ë∫´ËøêÂä®ÂêßÔºåË∑≥Áª≥ÔºåË∑ëÊ≠•ÔºåËÆ≠ÁªÉÂä®‰Ωú‰ªÄ‰πàÁöÑ„ÄÇ";
      } else if (value === "‰∏äËØæ‰∏çËøüÂà∞") {
        title.value = value;
        desc.value = "‰∏äËØæ‰∏çËøüÂà∞ÔºåÊâçËÉΩÊõ¥Â•ΩÁöÑÂ≠¶‰π†ÔºåÂä†Ê≤πÔºÅ";
      } else if (value === "ÂÅö‰πñÂÆùÂÆù") {
        title.value = value;
        desc.value = "‰πñ‰πñÊâçËÉΩÊõ¥Â•ΩÁöÑÁª¥ÊåÅÂèåÊñπÊÑüÊÉÖÔºåÊúÄÂñúÊ¨¢‰πñ‰πñÁöÑÊçèÊçè‰∫ÜÔºÅ";
      } else if (value === "‰π∞Â∞èÁ§ºÁâ©") {
        title.value = value;
        desc.value = "‰π∞ÁÇπÂ∞èÁ§ºÁâ©ÔºåÂÉèÊ≥°Ê≥°È©¨Áâπ‰ªÄ‰πàÁöÑ„ÄÇ";
      } else if (value === "Â•ΩÊÑüÂàÜ") {
        title.value = value;
        desc.value = "‰ªäÂ§©Ë°®Áé∞ÂæàÊ£íÔºåÂ•ΩÊÑüÂä†ÂàÜÔºÅ";
      } else if (value === "Â∏ÆÊãø‰∏úË•ø") {
        title.value = value;
        desc.value =
          "Êúâ‰∫ÜÊàëÔºå‰Ω†ÂÜç‰πü‰∏çÈúÄË¶ÅÁßªÂä®‰∫Ü„ÄÇÊãøÂ§ñÂçñÔºåÊãøÈõ∂È£üÔºåÂºÄÁ©∫Ë∞ÉÔºåÂºÄÁîµËßÜÔºåÂú®ÊâÄ‰∏çËæû„ÄÇ";
      } else if (value === "‰∏çÂñùÈ•ÆÊñô") {
        title.value = value;
        desc.value = "‰∏çÂñùÈ•ÆÊñôÔºåÂáèËÇ•ÔºåÊãíÁªùÁ≥ñÂàÜÔºåÂñùÂ§öÈ•ÆÊñôÂØπË∫´‰Ωì‰∏çÂ•ΩÁöÑÔºÅ";
      } else if (value === "ËÆ§ÁúüÁúãËØæ") {
        title.value = value;
        desc.value = "ËÆ§ÁúüÁúãËØæÔºå‰∏∫Êú™Êù•ÁöÑÁæéÂ•ΩÂä†Ê≤πÔºåÂ•ãÊñóÔºåÂ••Âà©ÁªôÔºÅ";
      } else if (value === "ËÉåÂçïËØç") {
        title.value = value;
        desc.value = "ËÉåÂõõÂÖ≠Á∫ßËÄÉÁ†îÂçïËØçÔºå‰∏∫‰∫ÜÊ¢¶ÊÉ≥Ôºå‰∏∫‰∫ÜÁêÜÊÉ≥Ôºå‰∏∫‰∫ÜÁîüÊ¥ªÔºåÂä†Ê≤πËÉåÔºÅ";
      } else if (value === "ÂêÉËî¨Ëèú") {
        title.value = value;
        desc.value =
          "ÂêÉËî¨ËèúÊúâÂà©‰∫éË∫´‰ΩìÂÅ•Â∫∑Ôºå‰∏∫Ë∫´‰ΩìË°•ÂÖÖÁª¥ÁîüÁ¥†ÔºåËøôÊ†∑Ë∫´‰ΩìÊâçËÉΩÊõ¥Ê£íÔºåË∫´ÊùêÊâçËÉΩÊõ¥Â•ΩÔºÅ";
      } else if (value === "ÁôΩÂ§©‰∏çÁù°Ëßâ") {
        title.value = value;
        desc.value =
          "ÁôΩÂ§©‰∏çÁù°ËßâÔºåÊôö‰∏äÊó©Áù°ÔºåÊó©‰∏äÊó©Ëµ∑ÔºåÂÖªÊàêËâØÂ•ΩÁîüÊ¥ª‰ΩúÊÅØ‰ªéÊàëÂÅöËµ∑ÔºÅ";
      }
    };

    const resetItem = () => {
      presetIndex.value = "Êó†È¢ÑËÆæ"; // ÈÄâÊã©È¢ÑËÆæÁöÑÂÄºÈáçÁΩÆ‰∏∫0Ôºå‰ΩøÁî®.value
      title.value = ""; // ‰ªªÂä°ÂêçÁß∞ÈáçÁΩÆ‰∏∫Á©∫
      desc.value = ""; // ‰ªªÂä°ËØ¶ÊÉÖÈáçÁΩÆ‰∏∫Á©∫
      credit.value = 0; // ÁßØÂàÜ‰ª∑Ê†ºÈáçÁΩÆ‰∏∫0
      useName.value = "";
    };

    const saveItem = () => {
      isLoading.value = true;
      // ÂáÜÂ§áË¶ÅÂèëÈÄÅÁöÑÊï∞ÊçÆÂØπË±°
      if (desc.value == "") {
        desc.value = "üòÇËøô‰∏™‰∫∫ÂæàÊáíÔºåÊ≤°ÊúâÂ°´ÂÜôÁõ∏ÂÖ≥ÁöÑ‰ªªÂä°ËØ¶ÊÉÖÔºÅ";
      }
      if (useName.value == "" || title.value == "") {
        message.value = "ËØ∑ÂÆåÊï¥Â°´Â•Ω‰∏äËø∞‰ø°ÊÅØÔºÅ"
        show.value = true;
        isLoading.value = false;
        return;
      }
      const value = parseFloat(credit.value);
      if (!Number.isInteger(value)) {
        message.value = "ÁßØÂàÜÂè™ËÉΩÊòØÊï¥Êï∞Âì¶ÔºåËØ∑ÈáçÊñ∞ËæìÂÖ•ÔºÅ"
        show.value = true;
        isLoading.value = false;
        return;
      }
      const task = {
        taskName: title.value,
        // ÂàõÂª∫‰∫∫ÁöÑid
        founderId: userId,
        taskText: desc.value,
        taskCredit: credit.value,
        useName: useName.value,
      };

      // ÂèëÈÄÅ POST ËØ∑Ê±ÇÂà∞ÊåáÂÆöÁöÑ URL
      fetch("/api/tasks", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${token}`,
        },
        body: JSON.stringify(task),
      })
        .then((response) => {
          if (response.ok) {
            // ËØ∑Ê±ÇÊàêÂäüÔºåÂèØ‰ª•Â§ÑÁêÜÊàêÂäüÁöÑÈÄªËæë
            message.value = "Ê∑ªÂä†ÊàêÂäüÔºÅ";
          } else {
            // ËØ∑Ê±ÇÂ§±Ë¥•ÔºåÂ§ÑÁêÜÈîôËØØÈÄªËæë
            message.value = "‰øùÂ≠ò‰ªªÂä°Â§±Ë¥•";
          }
        })
        .catch((error) => {
          // ÊçïËé∑ÂºÇÂ∏∏
          console.error("‰øùÂ≠ò‰ªªÂä°Êó∂Âá∫Áé∞ÈîôËØØ:", error);
        });
      show_1.value = true;
      setTimeout(() => {
        router.replace("/Task");
      }, 1000); // 2000ÊØ´ÁßíÁ≠â‰∫é2Áßí
      isLoading.value = false;
    };

    return {
      message,
      show,
      show_1,
      isLoading,
      columns,
      onConfirm,
      showPicker,
      presetIndex,
      title,
      desc,
      useName,
      credit,
      resetItem,
      saveItem,
      onClickLeft,
      images,
      userColumns,
      onConfirm_1,
      showPicker_1,
    };
  },
};
</script>

<style>
.page-contain {
  margin-top: 25px;
  display: flex;
  justify-content: center;
  height: 100%;
  width: 100%;
  overflow-y: auto;
  /* ÊòæÁ§∫ÂûÇÁõ¥ÊªöÂä®Êù° */
  overflow-x: hidden;
  /* ÈöêËóèÊ∞¥Âπ≥ÊªöÂä®Êù° */
  zoom: 1;
  /* Á¶ÅÊ≠¢È°µÈù¢ÂÜÖÂÆπÁº©Êîæ */
}

.image-slider_task {
  width: 100%;
  height: 80%;
  margin-top: 5px;
  transform: translateX(0%);
}

.form-container_task {
  margin-top: 28px;
}

.footer_task {
  display: flex;
  justify-content: space-between;
  margin-top: 30px;
}

.content_addIndex {
  width: 90%;
  margin-bottom: 20px;
}

.btn-reset {
  flex: 1;
  margin-right: 10px;
}

.btn-save {
  flex: 1;
  margin-left: 10px;
}

.bottom-tabbar {
  position: fixed;
  bottom: 0;
  width: 100%;
  background-color: #fff;
  border-top: 1px solid #ccc;
}

.van-picker__confirm {
    color:#F19290;
}
</style>
