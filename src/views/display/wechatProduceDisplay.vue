<template>
  <div style="--van-nav-bar-icon-color: #f19290">
    <van-nav-bar
      title="Ë∂ÖÂ∏ÇÂïÜÂìÅ"
      left-text=""
      left-arrow
      @click-left="onClickLeft"
    />
  </div>
  <div class="page-container">
    <div class="display_produce">
      <br />
      <div v-if="data === null">
        <!-- Â¶ÇÊûú‰∏∫Á©∫ÔºåÊ∏≤Êüì <van-empty> ÁªÑ‰ª∂ -->
        <div style="transform: translate(0px, -10px)">
          <van-empty
            image-size="26rem"
            description="üò≠ÂïÜÂìÅÂ∑≤ÂîÆÂÆåÔºåÂø´ÂéªÂàõÂª∫‰∏Ä
            ‰∏™ÂêßÔºÅ"
          />
        </div>
      </div>
      <div v-if="data">
        <van-form class="form-container">
          <div
            style="display: flex; justify-content: center; align-items: center"
          >
            <van-image
              width="22vh"
              height="22vh"
              position="center"
              fit="cover"
              round
              :src="imageUrl"
              @click="picture"
            />
          </div>
          <br />
          <meta
            name="viewport"
            content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0,user-scalable=no"
          />
          <van-field label="üìåÂïÜÂìÅÂêçÁß∞" v-model="title" :readonly="true" />
          <van-field
            label="üìùÂïÜÂìÅËØ¶ÊÉÖ"
            v-model="desc"
            type="textarea"
            rows="3"
            :readonly="true"
          />
          <van-field label="üí∞ÁßØÂàÜ‰ª∑Ê†º" v-model="credit" :readonly="true" />
          <van-field label="üß©ÂïÜÂìÅÊï∞Èáè" v-model="num" :readonly="true" />
          <van-field
            label="ü¶ÑÂàõÂª∫ÂØπË±°"
            v-model="founderName"
            :readonly="true"
          />
          <van-field label="ü§ñÂïÜÂìÅÂØπË±°" v-model="useName" :readonly="true" />
          <van-field label="‚è±Êõ¥Êñ∞Êó∂Èó¥" v-model="updateTime" :readonly="true" />
          <van-field
            label="üìÖÊ≥®ÂÜåÊó∂Èó¥"
            v-model="registerTime"
            :readonly="true"
          />
          <div style="margin: 8px; transform: translateY(9px)">
            <van-button
              @click="data.produceNum > 0 ? buyItem(data) : haveBuyItem()"
              round
              block
              color="#F19290"
              native-type="submit"
            >
              {{ data.produceNum > 0 ? "Ë¥≠‰π∞ÂïÜÂìÅ" : "Â∑≤ÂîÆÂÆå" }}
            </van-button>
            <br />
          </div>
        </van-form>
      </div>
      <van-dialog
        v-model:show="show"
        :close-on-click-overlay="true"
        :show-cancel-button="false"
        :show-confirm-button="false"
        :width="picturewidth"
      >
        <div
          style="display: flex; justify-content: center; align-items: center"
        >
          <van-image
            width="100vw"
            height="100vw"
            position="center"
            fit="cover"
            :src="imageUrl"
          />
        </div>
      </van-dialog>
      <van-dialog
        v-model:show="show_1"
        :show-cancel-button="false"
        :show-confirm-button="false"
        width="50vw"
      >
        <br />
        <br />
        <van-loading size="40px" vertical text-size="15px" color="#f19290"
          >üöÄÊãºÂëΩÂä†ËΩΩ‰∏≠...</van-loading
        >
        <br />
        <br />
      </van-dialog>
      <van-dialog
        v-model:show="show_2"
        @confirm="checkConfirm"
        @cancel="checkCancel"
        title="ü•∞ Ê∏©È¶®ÊèêÁ§∫"
        message="ü¶ÑÊÇ®Á°ÆÂÆöË¶ÅË¥≠‰π∞Ëøô‰ª∂ÂïÜÂìÅ‰∫ÜÂòõÔºü"
        show-cancel-button
      >
      </van-dialog>
      <van-dialog
        v-model:show="show_3"
        title="Ë¥≠‰π∞ÂïÜÂìÅÂ§±Ë¥•"
        message="üò≠ÊÇ®ÁöÑÁßØÂàÜ‰∏çÂ§üÔºåÂø´ÂéªÂÆåÊàê‰ªªÂä°Ëé∑ÂèñÁßØÂàÜÂêßÂïäüí™"
        show-cancel-button
      >
      </van-dialog>
      <van-dialog
        v-model:show="show_6"
        title="ü•∞ Ê∏©È¶®ÊèêÁ§∫"
        message="üòÇÊÇ®‰∏çËÉΩË¥≠‰π∞Âà´‰∫∫ÁöÑ‰∏ìÂ±ûÂïÜÂìÅÂì¶ÔºåÂø´ÂéªÂÆåÊàêËá™Â∑±ÁöÑ‰ªªÂä°ÔºåË¥≠‰π∞Â±û‰∫éËá™Â∑±ÁöÑÂïÜÂìÅÂêßÔºÅ"
      >
      </van-dialog>
      <van-dialog
        v-model:show="show_8"
        title="ü•∞ÊÅ≠Âñú"
        :message="message"
        width="70vw"
        height="30vw"
        :close-on-click-overlay="true"
        :show-cancel-button="false"
        :show-confirm-button="false"
      >
      </van-dialog>
    </div>
  </div>
</template>
  
  <script>
import { ref, onMounted } from "vue";
import axios from "axios";
import { useRouter } from "vue-router";
import jwtDecode from "jwt-decode";

export default {
  setup() {
    const picturewidth = ref();
    picturewidth.value = 0.8 * window.innerWidth;
    const router = useRouter();
    const message = ref("");
    const show = ref(false);
    const show_1 = ref(false);
    const show_2 = ref(false);
    const show_3 = ref(false);
    const show_6 = ref(false);
    const show_8 = ref(false);

    const picture = () => (show.value = true);

    const onClickLeft = () => router.replace("/Produce");
    const imageUrl = ref("");
    const title = ref("");
    const desc = ref("");
    const credit = ref("");
    const num = ref("");
    const founderName = ref("");
    const useName = ref("");
    const registerTime = ref("");
    const updateTime = ref("");
    const data = ref("");
    const token = localStorage.getItem("jwtToken"); // ‰ªélocalStorageËé∑ÂèñJWT‰ª§Áâå
    if (!token) {
      router.replace("/login");
    }

    const headers = {
      Authorization: `Bearer ${token}`,
    };

    let userId = "";
    const fetchLoginToken = () => {
      axios
        .post("/api/loginToken?token=" + token)
        .then((response) => {
          if (response.data.code == 0) {
            console.error(response.data.data);
            router.replace("/login");
          }
          console.log(response.data.data);
          // Âú®ËøôÈáåÂ§ÑÁêÜÁôªÂΩï‰ª§ÁâåÊé•Âè£ÁöÑÂìçÂ∫î
          // Â¶ÇÊûúÈúÄË¶ÅÊâßË°å‰∏Ä‰∫õÁâπÂÆöÁöÑÊìç‰ΩúÔºåÂèØ‰ª•Âú®ËøôÈáåÊ∑ªÂä†‰ª£Á†Å
        })
        .catch((error) => {
          console.error("ËØ∑Ê±ÇloginTokenÊé•Âè£Â§±Ë¥•", error);
          router.replace("/login");
        });
      const decodedToken = jwtDecode(token);
      // ‰ªéËß£Á†ÅÂêéÁöÑ‰ª§Áâå‰∏≠Ëé∑ÂèñÁâπÂÆöÁöÑÊï∞ÊçÆ
      userId = decodedToken.id; // ‰ªé‰ª§Áâå‰∏≠Ëé∑ÂèñÁî®Êà∑ID
    };

    const id = router.currentRoute.value.params.id;

    let strippedId = id.replace(":", "");

    const fetchDataAndFillForm = async () => {
      try {
        const response = await axios.get(
          `/api/idSelectProduce?id=${strippedId}`,
          { headers }
        );
        data.value = response.data.data; // ÂÅáËÆæÊúçÂä°Âô®ËøîÂõûÁöÑÊï∞ÊçÆÊòØ‰∏Ä‰∏™ÂåÖÂê´‰∏äËø∞Â≠óÊÆµÁöÑÂØπË±°

        // Â°´ÂÖÖË°®ÂçïÂ≠óÊÆµ
        imageUrl.value = data.value.produceImage;
        title.value = data.value.produceName;
        if (data.value.produceText == "") {
          desc.value = "üòÇËøô‰∏™‰∫∫ÂæàÊáíÔºåÊ≤°ÊúâÂ°´ÂÜôÁõ∏ÂÖ≥ÁöÑÂïÜÂìÅËØ¶ÊÉÖÔºÅ";
        } else desc.value = data.value.produceText;
        credit.value = data.value.produceCredit;
        num.value = data.value.produceNum;
        useName.value = data.value.customer;
        registerTime.value = data.value.registerTime;
        updateTime.value = data.value.updateTime;
        const founderId = data.value.founderId;

        const res = await axios.get(
          `/api/selectUser?id=${founderId}`,
          { headers }
        );
        const resDate = res.data.data; // ÂÅáËÆæÊúçÂä°Âô®ËøîÂõûÁöÑÊï∞ÊçÆÊòØ‰∏Ä‰∏™ÂåÖÂê´‰∏äËø∞Â≠óÊÆµÁöÑÂØπË±°
        founderName.value = resDate.name;
      } catch (error) {
        console.error("Ëé∑ÂèñÊï∞ÊçÆÂ§±Ë¥•", error);
      }
      show_1.value = false;
    };
    // Âú®ÁªÑ‰ª∂Âä†ËΩΩÂÆåÊàêÂêéËá™Âä®Ëß¶ÂèëÊï∞ÊçÆÂä†ËΩΩÂíåÂ°´ÂÖÖ
    onMounted(() => {
      fetchDataAndFillForm();
      fetchLoginToken();
    });

    let data_tem = "";
    const buyItem = (data) => {
      axios
        .get(`/api/selectCredit?name=${data.customer}`, {
          headers,
        })
        .then((response) => {
          const nameId = response.data.data.nameId;
          if (nameId == userId) {
            data_tem = data;
            show_2.value = true;
          } else show_6.value = true;
        });
    };
    const checkConfirm = () => {
      show_1.value = true; // ÂàùÂßãÊó∂ÊòæÁ§∫Âä†ËΩΩ‰∏≠ÊïàÊûú
      buyProduce(data_tem);
    };
    const checkCancel = () => {
      return;
    };
    const buyProduce = (data_tem) => {
      axios
        .get(
          `/api/selectCredit?name=${data_tem.customer}`,
          {
            headers,
          }
        )
        .then((response) => {
          // Â§ÑÁêÜËé∑ÂèñÊàêÂäüÁöÑÈÄªËæë
          console.log("Ëé∑ÂèñÊï∞ÊçÆÊàêÂäü", response);
          const buyCredit = response.data.data.credit;
          if (buyCredit >= data_tem.produceCredit) {
            // ÂèëÈÄÅ HTTP PUT ËØ∑Ê±ÇÊù•ÂÆåÊàêË¥≠‰π∞Êìç‰Ωú
            axios
              .put(
                `/api/buyProduce?id=${data_tem.produceId}`,
                null,
                {
                  headers,
                }
              )
              .then((response) => {
                // Â§ÑÁêÜÂÆåÊàêÊàêÂäüÁöÑÈÄªËæë
                console.log("‰ªªÂä°Â∑≤‰øùÂ≠òÊàêÂäü", response.data);
                show_1.value = false;
                message.value = "Ë¥≠‰π∞ÊàêÂäüÔºÅ";
                num.value = num.value - 1;
                data.value.produceNum = data.value.produceNum - 1;
              })
              .catch((error) => {
                // Â§ÑÁêÜÂÆåÊàêÂ§±Ë¥•ÁöÑÈÄªËæë
                console.error("Êï∞ÊçÆÂÆåÊàêÂ§±Ë¥•", error);
                message.value = "Ë¥≠‰π∞Â§±Ë¥•ÔºÅ";
              });
          } else {
            show_3.value = true;
          }
        })
        .catch((error) => {
          // Â§ÑÁêÜËé∑ÂèñÂ§±Ë¥•ÁöÑÈÄªËæë
          console.error("Ëé∑ÂèñÊï∞ÊçÆÂ§±Ë¥•", error);
        });
      show_8.value = true; // ÊòæÁ§∫
      // Á≠âÂæÖ‰∏§ÁßíÂêéÊâßË°åÂÖ≥Èó≠Êìç‰Ωú
      setTimeout(() => {
        show_8.value = false; // ÂÖ≥Èó≠
      }, 1000); // 2000ÊØ´ÁßíÁ≠â‰∫é2Áßí
      show_1.value = false;
    };

    const haveBuyItem = () => {
      return;
    };
    return {
      message,
      data,
      picturewidth,
      show,
      show_1,
      show_2,
      show_3,
      show_6,
      show_8,
      picture,
      onClickLeft,
      imageUrl,
      title,
      desc,
      credit,
      num,
      founderName,
      useName,
      registerTime,
      updateTime,
      fetchDataAndFillForm,
      checkConfirm,
      checkCancel,
      buyItem,
      haveBuyItem,
    };
  },
};
</script>
  
  <style>
.page-container {
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100%;
  width: 100%;
  overflow-y: auto;
  /* ÊòæÁ§∫ÂûÇÁõ¥ÊªöÂä®Êù° */
  overflow-x: hidden;
  /* ÈöêËóèÊ∞¥Âπ≥ÊªöÂä®Êù° */
  zoom: 1;
  /* Á¶ÅÊ≠¢È°µÈù¢ÂÜÖÂÆπÁº©Êîæ */
}

.van-uploader {
  position: relative;
  display: inline-block;
  /* transform: translateX(158px); */
  display: flex;
  justify-content: center;
}

.display_produce {
  width: 90%;
  margin-bottom: 10vh;
}

.form-container {
  margin-top: 0px;
}
</style>
  